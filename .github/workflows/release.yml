name: Create GitHub Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v1.2.3)"
        required: true

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        shell: bash
        run: |
          # Determine tag name for push-vs-dispatch.
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "TAG=$TAG" >> "$GITHUB_ENV"

          # GHCR requires lowercase image names
          echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Create release (with generated notes)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists; skipping."
            exit 0
          fi

          gh release create "$TAG" --title "$TAG" --generate-notes

          # Append container info to the generated notes.
          BODY="$(gh release view "$TAG" --json body -q .body)"
          printf "%s\n\n## Container image\n- %s:%s\n- %s:latest\n" \
            "$BODY" \
            "$IMAGE_NAME" "$TAG" \
            "$IMAGE_NAME" \
            > release-notes.md

          gh release edit "$TAG" --notes-file release-notes.md
